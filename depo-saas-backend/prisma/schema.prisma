generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
  // "native": Kendi bilgisayarınız (Mac) için
  // "debian-openssl-3.0.x": Cloud Run (Linux) için
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. SİSTEM VE ABONELİK YÖNETİMİ
// ==========================================

model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String
  code          String   @unique // FREE, STARTER, PRO, ENTERPRISE
  price         Float
  currency      String   @default("₺")
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  
  maxUsers      Int
  maxProducts   Int
  maxWarehouses Int
  maxBranches   Int      @default(0)
  
  features      String[]
  isPopular     Boolean  @default(false)
  
  tenants       Tenant[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model EnterpriseRequest {
  id          String   @id @default(uuid())
  companyName String
  fullName    String
  email       String
  phone       String
  message     String?
  status      RequestStatus @default(PENDING)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum RequestStatus {
  PENDING
  CONTACTED
  CLOSED
}

// ==========================================
// 2. ŞİRKET, ŞUBE VE KULLANICI YAPISI
// ==========================================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  subdomain   String   @unique
  isActive    Boolean  @default(true)
  phone       String?
  address     String?
  taxNo       String?
  taxOffice   String?
  contactName String?
  website     String?
  planId      String?
  plan        SubscriptionPlan? @relation(fields: [planId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users               User[]
  branches            Branch[]
  warehouses          Warehouse[]
  departments         Department[]
  suppliers           Supplier[]
  products            Product[]
  transactions        Transaction[]
  procurementRequests ProcurementRequest[]
  purchaseOrders      PurchaseOrder[]
  stockForms          StockForm[] 
}

model Branch {
  id          String   @id @default(uuid())
  name        String
  location    String?
  phone       String?
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  warehouses          Warehouse[]
  users               User[]
  procurementRequests ProcurementRequest[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  @@unique([tenantId, name])
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  fullName  String?
  phone     String?
  role      Role     @default(STAFF)
  
  isPasswordChanged Boolean @default(false)
  canCreateProduct Boolean @default(false)
  autoApprove      Boolean  @default(false)
  tags             String[]
  
  branchId         String?
  branch           Branch? @relation(fields: [branchId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // İlişkiler
  logs                 Log[]
  createdTransactions  Transaction[] @relation("CreatedBy")
  approvedTransactions Transaction[] @relation("ApprovedBy")
  notifications        Notification[]
  createdProducts      Product[] @relation("ProductCreator")
  requests             ProcurementRequest[] @relation("Requester")
  createdPurchaseOrders PurchaseOrder[] @relation("POCreator")
  createdStockForms    StockForm[] @relation("FormCreator")
  
  dashboardConfig      DashboardConfig? 

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
}

enum Role {
  SUPER_ADMIN
  ADMIN
  BRANCH_MANAGER
  STAFF
  VIEWER
}

// ==========================================
// 3. ENVANTER YÖNETİMİ
// ==========================================

model Warehouse {
  id        String   @id @default(uuid())
  name      String
  location  String?
  branchId  String?
  branch    Branch?  @relation(fields: [branchId], references: [id])
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  products    Product[]
  departments Department[]
  deletedAt DateTime?
  @@unique([tenantId, name])
}

model Department {
  id        String   @id @default(uuid())
  name      String
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)
  products    Product[]
  deletedAt   DateTime?
  @@unique([tenantId, name])
}

model Supplier {
  id          String   @id @default(uuid())
  name        String
  contactName String?
  phone       String?
  email       String?
  address     String?
  category    String?
  isActive    Boolean  @default(true)
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  
  transactions Transaction[]
  productLinks ProductSupplier[]
  products     Product[]
  purchaseOrders PurchaseOrder[]
  stockForms   StockForm[] 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  @@unique([tenantId, name])
}

model ProductSupplier {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  isMain     Boolean  @default(false)
  @@unique([productId, supplierId])
}

model Product {
  id           String   @id @default(uuid())
  name         String
  sku          String
  barcode      String?
  description  String?
  buyingPrice  Float    @default(0)
  sellingPrice Float    @default(0)
  minStock     Int      @default(10)
  currentStock Int      @default(0)
  unitType     String   @default("PIECE")
  itemsPerBox  Int      @default(1)
  batchNumber    String?
  expirationDate DateTime?
  
  warehouseId  String?
  warehouse    Warehouse? @relation(fields: [warehouseId], references: [id])
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  supplierId   String?
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  suppliers    ProductSupplier[]

  status          ProductStatus @default(PENDING)
  rejectionReason String?
  documentUrl     String?
  isCash          Boolean       @default(true)
  paymentDate     DateTime?

  createdById  String?
  createdBy    User?    @relation("ProductCreator", fields: [createdById], references: [id])
  tenantId     String
  tenant       Tenant    @relation(fields: [tenantId], references: [id])
  
  transactions Transaction[]
  procurementRequests ProcurementRequest[]
  purchaseOrderItems PurchaseOrderItem[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?
  @@unique([tenantId, sku])
}

enum ProductStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==========================================
// 4. İŞLEM VE SİPARİŞLER
// ==========================================

model StockForm {
  id          String   @id @default(uuid())
  formNumber  String   // Fiş No
  type        TransactionType
  
  waybillNo   String?
  waybillDate DateTime?
  notes       String?

  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdById String
  createdBy   User     @relation("FormCreator", fields: [createdById], references: [id])

  transactions Transaction[] 

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Transaction {
  id          String   @id @default(uuid())
  type        TransactionType
  quantity    Int
  status      Status   @default(PENDING)
  
  waybillNo   String?
  waybillDate DateTime?
  paymentDate DateTime?
  documentUrl String?
  notes       String?
  isCash      Boolean  @default(true)
  isPaid      Boolean  @default(false)
  batchNumber    String?
  expirationDate DateTime?

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplierId  String?
  supplier    Supplier? @relation(fields: [supplierId], references: [id])
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  createdById String
  createdBy   User     @relation("CreatedBy", fields: [createdById], references: [id])
  approvedById String?
  approvedBy   User?    @relation("ApprovedBy", fields: [approvedById], references: [id])

  stockFormId String?
  stockForm   StockForm? @relation(fields: [stockFormId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum TransactionType {
  INBOUND
  OUTBOUND
  WASTAGE
}

enum Status {
  PENDING
  APPROVED
  REJECTED
}

model PurchaseOrder {
  id            String   @id @default(uuid())
  orderNumber   String
  status        OrderStatus @default(DRAFT)
  expectedDate  DateTime?
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  items         PurchaseOrderItem[]
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  createdById   String
  createdBy     User     @relation("POCreator", fields: [createdById], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model PurchaseOrderItem {
  id               String   @id @default(uuid())
  purchaseOrderId  String
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId        String
  product          Product       @relation(fields: [productId], references: [id])
  quantityExpected Int      
  quantityReceived Int      @default(0)
  unitPrice        Float?   
  notes            String?  
  @@unique([purchaseOrderId, productId])
}

enum OrderStatus {
  DRAFT
  ORDERED
  PARTIAL
  COMPLETED
  CANCELLED
}

model ProcurementRequest {
  id           String   @id @default(uuid())
  quantity     Int
  reason       String?  
  status       ProcurementStatus @default(PENDING)
  type         RequestType       @default(PURCHASE)
  adminNote    String?  
  deliveryDate DateTime? 
  productId    String
  product      Product  @relation(fields: [productId], references: [id])
  requesterId  String
  requester    User     @relation("Requester", fields: [requesterId], references: [id])
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum ProcurementStatus {
  PENDING
  APPROVED
  ORDERED
  REJECTED
  DELIVERED
}

enum RequestType {
  PURCHASE   
  STOCK_OUT  
  INBOUND    
}

// ==========================================
// 5. DİĞER (LOG, BİLDİRİM, DASHBOARD)
// ==========================================

model DashboardConfig {
  id        String   @id @default(uuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  layout    Json     
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Log {
  id        String   @id @default(uuid())
  action    String
  details   String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   
  user      User     @relation(fields: [userId], references: [id])
  message   String
  read      Boolean  @default(false)
  type      String   
  createdAt DateTime @default(now())
}